<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adventure Game</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #0c0a1f; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
/**
 * CONSTANTS & GLOBAL CONFIG
 */
const GROUND_HEIGHT_LV1 = 120;
const PLAYER_SIZE = 80;

const GameStatus = {
  MENU: 'MENU',
  SELECT_CHAR: 'SELECT_CHAR',
  STORY_INTRO: 'STORY_INTRO',
  PLAYING: 'PLAYING',
  GAMEOVER: 'GAMEOVER',
  LEVEL_COMPLETE: 'LEVEL_COMPLETE',
  STORY_INTERSTITIAL: 'STORY_INTERSTITIAL',
  PIZZA_DECISION_PRE: 'PIZZA_DECISION_PRE',
  MOUNTAIN_INSTRUCTIONS: 'MOUNTAIN_INSTRUCTIONS',
  POST_MOUNTAIN_STORY: 'POST_MOUNTAIN_STORY',
  LEVEL_3_PRE_SELECT: 'LEVEL_3_PRE_SELECT',
  LEVEL_3_CHAR_SELECT: 'LEVEL_3_CHAR_SELECT',
  LEVEL_SELECT: 'LEVEL_SELECT',
  DATING_BEGINS: 'DATING_BEGINS',
  GO_TO_SAIPAN: 'GO_TO_SAIPAN',
  LEVEL_4_INTRO: 'LEVEL_4_INTRO'
};

const LEVEL_CONFIGS = {
  1: {
    themeName: "HAN RIVER PARK",
    gravity: 0.6,
    jumpForce: -14,
    scrollSpeed: 5,
    primaryColor: "#166534", 
    shadowColor: "#052e16",
    charScale: 2.0,
    segments: [
      { id: 'start', type: 'flat', length: 1200 },
      { id: 'o1', type: 'obstacle', length: 1000, obstacleType: 'pillow_monster' },
      { id: 'o2', type: 'obstacle', length: 1000, obstacleType: 'pillow_monster' },
      { id: 'o3', type: 'obstacle', length: 1000, obstacleType: 'pillow_monster' },
      { id: 'o4', type: 'obstacle', length: 1000, obstacleType: 'pillow_monster' },
      { id: 'o5', type: 'obstacle', length: 1000, obstacleType: 'pillow_monster' },
      { id: 'o6', type: 'obstacle', length: 1000, obstacleType: 'pillow_monster' },
      { id: 'end', type: 'flat', length: 1200, hasPartner: true }
    ]
  },
  2: {
    themeName: "YONGMASAN",
    gravity: 0.6,
    jumpForce: -14,
    scrollSpeed: 4.5,
    primaryColor: "#15803d", 
    shadowColor: "#064e3b",  
    charScale: 1.2,
    segments: [
      { id: 's2-start', type: 'flat', length: 1500 },
      { id: 's2-o1', type: 'obstacle', length: 1100, obstacleType: 'tree' },
      { id: 's2-o2', type: 'obstacle', length: 1100, obstacleType: 'tree' },
      { id: 's2-o3', type: 'obstacle', length: 1100, obstacleType: 'tree' },
      { id: 's2-o4', type: 'obstacle', length: 1100, obstacleType: 'tree' },
      { id: 's2-o5', type: 'obstacle', length: 1100, obstacleType: 'tree' },
      { id: 's2-o6', type: 'obstacle', length: 1100, obstacleType: 'tree' },
      { id: 's2-o7', type: 'obstacle', length: 1100, obstacleType: 'tree' },
      { id: 's2-end', type: 'flat', length: 2500, hasFebreze: true }
    ]
  },
  3: {
    themeName: "CHEESEWICK",
    type: "CATCHING",
    charScale: 1.8,
    primaryColor: "#451a03", // Wood floor color
    shadowColor: "#271104"
  },
  4: {
    themeName: "SAIPAN AIRPORT",
    type: "WAKEUP",
    charScale: 2.5,
    primaryColor: "#334155",
    shadowColor: "#0f172a"
  }
};

const App = () => {
  const [gameState, setGameState] = useState({
    status: GameStatus.MENU,
    levelNumber: 1,
    character: 'male', 
    score: 0,
    pizzasCaught: 0,
    zsTapped: 0,
    deathReason: null
  });

  const canvasRef = useRef(null);
  const requestRef = useRef();
  const statusRef = useRef(GameStatus.MENU);
  const keysPressed = useRef({});
  
  const playerRef = useRef({
    worldX: 0, 
    x: 0, 
    y: 0, 
    vy: 0,
    frame: 0,
    passedObstacles: new Set()
  });

  const entitiesRef = useRef([]); 
  const isCelebrating = useRef(false);

  useEffect(() => {
    statusRef.current = gameState.status;
  }, [gameState.status]);

  const getGroundY = useCallback((worldX) => {
    if (!canvasRef.current) return 0;
    const height = canvasRef.current.height;
    if (gameState.levelNumber === 2) {
      const baseGround = height - 250;
      return baseGround + (worldX * 0.1); 
    }
    return height - GROUND_HEIGHT_LV1;
  }, [gameState.levelNumber]);

  const drawPixelRect = (ctx, x, y, w, h, color, shadowColor, outline = true) => {
    if (outline) {
      ctx.fillStyle = '#000000';
      ctx.fillRect(x - 2, y - 2, w + 4, h + 4);
    }
    ctx.fillStyle = color;
    ctx.fillRect(x, y, w, h);
    if (shadowColor) {
      ctx.fillStyle = shadowColor;
      ctx.fillRect(x + (w * 0.6), y, w * 0.4, h);
      ctx.fillRect(x, y + (h * 0.7), w, h * 0.3);
    }
  };

  const renderCharacterBase = (ctx, char, frame = 0, isFallingAsleep = false) => {
    const skin = '#ffd6cc';
    const skinShadow = '#e0b3a8';
    
    if (char === 'male') {
      drawPixelRect(ctx, 30, 60, 40, 40, '#2563eb', '#1e40af');
      drawPixelRect(ctx, 30, 20, 40, 40, skin, skinShadow);
      ctx.fillStyle = '#000';
      ctx.fillRect(31, 31, 14, 12);
      ctx.fillRect(55, 31, 14, 12);
      ctx.fillRect(45, 34, 10, 3);
      ctx.fillStyle = skin; 
      ctx.fillRect(34, 34, 8, 6);
      ctx.fillRect(58, 34, 8, 6);
    } else {
      const hairColor = '#222';
      const hairShadow = '#000';
      drawPixelRect(ctx, 24, 16, 52, 6, hairColor, hairShadow);
      drawPixelRect(ctx, 18, 22, 64, 38, hairColor, hairShadow);
      drawPixelRect(ctx, 18, 60, 15, 10, hairColor, hairShadow);
      drawPixelRect(ctx, 67, 60, 15, 10, hairColor, hairShadow);
      
      const faceX = 30;
      const faceY = 28;
      const faceW = 40;
      const faceH = 38;
      ctx.fillStyle = '#000';
      ctx.fillRect(faceX - 2, faceY + 2, faceW + 4, faceH - 4);
      ctx.fillRect(faceX + 2, faceY - 2, faceW - 4, faceH + 4);
      ctx.fillStyle = skin;
      ctx.fillRect(faceX, faceY, faceW, faceH);
      
      ctx.fillStyle = hairColor; 
      ctx.fillRect(faceX, faceY, 4, 4); 
      ctx.fillRect(faceX + faceW - 4, faceY, 4, 4); 
      
      ctx.fillStyle = skinShadow;
      ctx.fillRect(faceX + faceW - 12, faceY + 20, 12, 18);
      
      // --- Eye Animation (Sleeping) ---
      ctx.fillStyle = '#000';
      let eyeHeight = 6;
      if (isFallingAsleep) {
        const cycle = frame % 120;
        if (cycle < 60) {
          eyeHeight = Math.max(1, 6 - Math.floor(cycle / 12));
        } else if (cycle < 90) {
          eyeHeight = 1;
        } else {
          eyeHeight = 6;
        }
      }
      
      const eyeY = 44 + (6 - eyeHeight) / 2;
      ctx.fillRect(38, eyeY, 6, eyeHeight); 
      ctx.fillRect(56, eyeY, 6, eyeHeight); 
      
      drawPixelRect(ctx, 30, 66, 40, 34, '#334155', '#1e293b');
    }
  };

  const drawBarBackground = (ctx, width, height) => {
    // Dimly lit interior walls
    ctx.fillStyle = '#1e1b4b'; 
    ctx.fillRect(0, 0, width, height);

    // Wall texture/panels
    ctx.fillStyle = '#110c1d';
    for(let i = 0; i < width; i += 120) {
        ctx.fillRect(i, 0, 4, height * 0.7);
    }

    // Bar Counter Silhouette
    ctx.fillStyle = '#0f172a';
    ctx.beginPath();
    ctx.moveTo(0, height * 0.55);
    ctx.lineTo(width * 0.2, height * 0.55);
    ctx.lineTo(width * 0.25, height * 0.7);
    ctx.lineTo(width, height * 0.7);
    ctx.lineTo(width, height);
    ctx.lineTo(0, height);
    ctx.fill();

    // Floor (Dark Wood)
    ctx.fillStyle = '#271104';
    ctx.fillRect(0, height - 100, width, 100);
    // Floor planks
    ctx.fillStyle = '#1a0b02';
    for(let i = 0; i < width; i += 80) {
        ctx.fillRect(i, height - 100, 2, 100);
    }

    // Neon Signs
    const signs = [
        { x: width * 0.15, y: height * 0.2, color: '#f472b6', text: 'PIZZA' },
        { x: width * 0.75, y: height * 0.15, color: '#facc15', text: 'OPEN' }
    ];

    signs.forEach(sign => {
        ctx.save();
        ctx.shadowBlur = 15;
        ctx.shadowColor = sign.color;
        ctx.strokeStyle = sign.color;
        ctx.lineWidth = 3;
        ctx.strokeRect(sign.x, sign.y, 120, 50);
        ctx.fillStyle = sign.color;
        ctx.font = '12px "Press Start 2P"';
        ctx.fillText(sign.text, sign.x + 15, sign.y + 32);
        ctx.restore();
    });

    // Hanging Lamps
    ctx.fillStyle = '#334155';
    for(let i = 0; i < 3; i++) {
        const lx = (width / 4) * (i + 1);
        ctx.fillRect(lx - 2, 0, 4, 100);
        ctx.fillStyle = '#fbbf24';
        ctx.beginPath();
        ctx.arc(lx, 110, 15, 0, Math.PI * 2);
        ctx.fill();
        // Light glow
        const grad = ctx.createRadialGradient(lx, 110, 0, lx, 110, 60);
        grad.addColorStop(0, 'rgba(251, 191, 36, 0.3)');
        grad.addColorStop(1, 'rgba(251, 191, 36, 0)');
        ctx.fillStyle = grad;
        ctx.fillRect(lx - 60, 110, 120, 150);
    }
  };

  const drawPizza = (ctx, x, y) => {
    ctx.save();
    ctx.translate(x, y);
    ctx.fillStyle = '#d97706';
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(-20, -40);
    ctx.lineTo(20, -40);
    ctx.fill();
    ctx.fillStyle = '#fde047';
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(-15, -30);
    ctx.lineTo(15, -30);
    ctx.fill();
    ctx.fillStyle = '#b91c1c';
    ctx.fillRect(-5, -20, 4, 4);
    ctx.fillRect(2, -25, 4, 4);
    ctx.restore();
  };

  const drawZ = (ctx, x, y, opacity) => {
    ctx.save();
    ctx.globalAlpha = opacity;
    ctx.fillStyle = '#fff';
    ctx.font = '24px "Press Start 2P"';
    ctx.fillText('Z', x, y);
    ctx.restore();
  };

  const drawAirportBackground = (ctx, width, height) => {
    // Sunset sky
    const skyGrad = ctx.createLinearGradient(0, 0, 0, height);
    skyGrad.addColorStop(0, '#f97316'); // Orange
    skyGrad.addColorStop(0.5, '#fb923c'); // Lighter orange
    skyGrad.addColorStop(0.7, '#fef3c7'); // Soft yellow
    ctx.fillStyle = skyGrad;
    ctx.fillRect(0, 0, width, height);

    // Airplane Silhouette
    ctx.save();
    ctx.translate(width * 0.7, height * 0.35);
    ctx.fillStyle = 'rgba(15, 23, 42, 0.4)'; // Dark silhouette with some alpha
    // Body
    ctx.fillRect(0, 0, 180, 40);
    // Tail
    ctx.beginPath();
    ctx.moveTo(180, 0);
    ctx.lineTo(210, -40);
    ctx.lineTo(210, 40);
    ctx.lineTo(180, 40);
    ctx.fill();
    // Wing
    ctx.beginPath();
    ctx.moveTo(60, 40);
    ctx.lineTo(100, 100);
    ctx.lineTo(130, 100);
    ctx.lineTo(110, 40);
    ctx.fill();
    ctx.restore();

    // Terminal Floor
    ctx.fillStyle = '#94a3b8';
    ctx.fillRect(0, height * 0.7, width, height * 0.3);
    // Floor details
    ctx.fillStyle = '#64748b';
    for (let i = 0; i < width; i += 200) {
      ctx.fillRect(i, height * 0.7, 4, height * 0.3);
    }
  };

  const loop = useCallback(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const { width, height } = canvas;
    const centerX = width / 2;
    const centerY = height / 2;

    if (statusRef.current === GameStatus.PLAYING) {
      const config = LEVEL_CONFIGS[gameState.levelNumber] || LEVEL_CONFIGS[1];
      const player = playerRef.current;
      player.frame++;

      ctx.clearRect(0, 0, width, height);

      // --- 1. DRAW BACKGROUNDS ---
      if (gameState.levelNumber === 1) {
        drawDuskCityscape(ctx, width, height, player.worldX, player.frame);
      } else if (gameState.levelNumber === 2) {
        drawMountainMorning(ctx, width, height, player.worldX, player.frame);
      } else if (config.type === "CATCHING") {
        drawBarBackground(ctx, width, height);
      } else if (gameState.levelNumber === 4) {
        drawAirportBackground(ctx, width, height);
      }

      // --- 2. GAMEPLAY LOGIC BY TYPE ---
      if (config.type === "CATCHING") {
        if (!isCelebrating.current) {
          if (keysPressed.current['ArrowLeft'] || keysPressed.current['a']) {
            player.x = Math.max(50, player.x - 10);
          }
          if (keysPressed.current['ArrowRight'] || keysPressed.current['d']) {
            player.x = Math.min(width - 50, player.x + 10);
          }

          if (player.frame % 40 === 0) {
            entitiesRef.current.push({
              id: Date.now(),
              x: Math.random() * (width - 100) + 50,
              y: -50,
              speed: 4 + Math.random() * 4
            });
          }
        }

        entitiesRef.current = entitiesRef.current.filter(p => {
          if (!isCelebrating.current) p.y += p.speed;
          drawPizza(ctx, p.x, p.y);
          
          const dist = Math.sqrt((p.x - player.x)**2 + (p.y - (height - 150))**2);
          if (dist < 50 && !isCelebrating.current) {
            setGameState(prev => {
              const newVal = prev.pizzasCaught + 1;
              const goal = prev.character === 'male' ? 20 : 4;
              if (newVal >= goal) {
                isCelebrating.current = true;
                setTimeout(() => setGameState(s => ({ ...s, status: GameStatus.DATING_BEGINS })), 2500);
              }
              return { ...prev, pizzasCaught: newVal, score: prev.score + 10 };
            });
            return false;
          }
          return p.y < height;
        });

        drawAvatar(ctx, player.x, height - 100 - (PLAYER_SIZE * config.charScale), gameState.character, player.frame, false, config.charScale);
      } 
      else if (config.type === "WAKEUP") {
        // Z spawning logic
        if (player.frame % 30 === 0) {
          entitiesRef.current.push({
            id: Math.random(),
            x: centerX + (Math.random() * 40 - 20),
            y: centerY - 50,
            vx: (Math.random() - 0.5) * 2,
            vy: -1.5 - Math.random() * 2,
            opacity: 1
          });
        }

        entitiesRef.current = entitiesRef.current.filter(z => {
          z.x += z.vx;
          z.y += z.vy;
          z.opacity -= 0.005;
          drawZ(ctx, z.x, z.y, z.opacity);
          return z.opacity > 0;
        });

        // Romy stays still in middle - isFallingAsleep set to true
        drawAvatar(ctx, centerX, centerY, 'female', player.frame, true, config.charScale, true);
      }
      else {
        // --- SIDESCROLLING LOGIC (Levels 1 & 2) ---
        if (!isCelebrating.current) {
          player.vy += config.gravity;
          player.y += player.vy;
          player.worldX += config.scrollSpeed;
          const gY = getGroundY(player.worldX);
          
          if (player.y + (PLAYER_SIZE * config.charScale) >= gY) {
              player.y = gY - (PLAYER_SIZE * config.charScale);
              player.vy = 0;
          }

          let accX = 0;
          config.segments.forEach(seg => {
              const obsX = accX + seg.length / 2;
              if (seg.type === 'obstacle') {
                  const screenObsX = obsX - player.worldX + centerX;
                  const obsY = getGroundY(obsX);
                  if (Math.abs(screenObsX - centerX) < 40 && player.y + (PLAYER_SIZE * config.charScale) > obsY - 30) {
                      setGameState(prev => ({ ...prev, status: GameStatus.GAMEOVER, deathReason: 'obstacle' }));
                  }
                  if (!player.passedObstacles.has(seg.id) && player.worldX > obsX) {
                      player.passedObstacles.add(seg.id);
                      setGameState(prev => ({ ...prev, score: prev.score + 100 }));
                  }
              }
              accX += seg.length;
          });

          const totalWidth = config.segments.reduce((a, b) => a + b.length, 0);
          const stopOffset = gameState.levelNumber === 2 ? 300 : 600; 

          if (player.worldX > totalWidth - stopOffset) {
              isCelebrating.current = true;
              player.worldX = totalWidth - stopOffset; 
              setTimeout(() => {
                  if (gameState.levelNumber === 1) setGameState(prev => ({ ...prev, status: GameStatus.STORY_INTERSTITIAL }));
                  else if (gameState.levelNumber === 2) setGameState(prev => ({ ...prev, status: GameStatus.POST_MOUNTAIN_STORY }));
                  else setGameState(prev => ({ ...prev, status: GameStatus.LEVEL_COMPLETE }));
              }, 5000); 
          }
        }

        const cameraOffset = gameState.levelNumber === 1 ? 0 : centerY - (player.y + (PLAYER_SIZE * config.charScale) / 2);

        let accX = 0;
        config.segments.forEach(seg => {
          const x = accX - player.worldX + centerX;
          const y = getGroundY(accX);
          drawGround(ctx, x, y, seg.length, config, accX, cameraOffset);

          if (seg.type === 'obstacle') {
            const obsXMid = accX + seg.length / 2;
            const drawX = x + seg.length / 2;
            const drawY = getGroundY(obsXMid) + cameraOffset;
            if (seg.obstacleType === 'tree') drawTree(ctx, drawX, drawY);
            else drawPillowMonster(ctx, drawX, drawY, player.frame);
          }
          
          if (seg.hasPartner) {
            const partnerRelativeX = seg.length - 450; 
            const partnerWorldX = accX + partnerRelativeX;
            const partnerX = x + partnerRelativeX;
            const partnerY = getGroundY(partnerWorldX) - (PLAYER_SIZE * config.charScale) + cameraOffset;
            
            drawAvatar(ctx, partnerX, partnerY, gameState.character === 'male' ? 'female' : 'male', player.frame, true, config.charScale);
            
            if (isCelebrating.current) {
              const heartX = (centerX + partnerX) / 2;
              drawHeart(ctx, heartX, partnerY - 120, player.frame, true);
            }
          }

          if (seg.hasFebreze) {
            const goalRelativeX = seg.length - 200;
            const goalWorldX = accX + goalRelativeX;
            const goalX = x + goalRelativeX;
            const goalY = getGroundY(goalWorldX) + cameraOffset;
            drawFebreze(ctx, goalX, goalY);
          }
          accX += seg.length;
        });

        drawAvatar(ctx, centerX, player.y + cameraOffset, gameState.character, player.frame, false, config.charScale);
      }
    }
    requestRef.current = requestAnimationFrame(loop);
  }, [gameState.levelNumber, gameState.character, getGroundY, gameState.score, gameState.pizzasCaught, gameState.zsTapped]);

  const handleAction = useCallback((clientX, clientY) => {
    const config = LEVEL_CONFIGS[gameState.levelNumber] || LEVEL_CONFIGS[1];
    const player = playerRef.current;
    
    if (config.type === "CATCHING") {
      if (!isCelebrating.current) player.x = clientX;
    } else if (config.type === "WAKEUP") {
      const tapX = clientX;
      const tapY = clientY;
      let hit = false;
      entitiesRef.current = entitiesRef.current.filter(z => {
        const dist = Math.sqrt((z.x - tapX)**2 + (z.y - tapY)**2);
        if (dist < 40) {
          hit = true;
          return false;
        }
        return true;
      });
      if (hit) {
        setGameState(prev => {
          const newVal = prev.zsTapped + 1;
          if (newVal >= 10) setTimeout(() => setGameState(s => ({ ...s, status: GameStatus.LEVEL_COMPLETE })), 100);
          return { ...prev, zsTapped: newVal };
        });
      }
    } else {
      const gY = getGroundY(player.worldX);
      if (player.y + (PLAYER_SIZE * config.charScale) >= gY - 10) player.vy = config.jumpForce;
    }
  }, [gameState.levelNumber, getGroundY]);

  useEffect(() => {
    const handleResize = () => { if (canvasRef.current) { canvasRef.current.width = window.innerWidth; canvasRef.current.height = window.innerHeight; } };
    window.addEventListener('resize', handleResize);
    handleResize();
    
    const handleKeyDown = (e) => { 
        keysPressed.current[e.key] = true;
        if (e.key === ' ' || e.key === 'ArrowUp') handleAction(); 
    };
    const handleKeyUp = (e) => { 
        keysPressed.current[e.key] = false;
    };

    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);
    window.addEventListener('mousedown', (e) => { if (statusRef.current === GameStatus.PLAYING) handleAction(e.clientX, e.clientY); });
    window.addEventListener('touchstart', (e) => { if (statusRef.current === GameStatus.PLAYING) handleAction(e.touches[0].clientX, e.touches[0].clientY); });
    window.addEventListener('mousemove', (e) => { if (statusRef.current === GameStatus.PLAYING) playerRef.current.x = e.clientX; });
    window.addEventListener('touchmove', (e) => { if (statusRef.current === GameStatus.PLAYING) playerRef.current.x = e.touches[0].clientX; });

    requestRef.current = requestAnimationFrame(loop);
    return () => { 
        window.removeEventListener('resize', handleResize); 
        window.removeEventListener('keydown', handleKeyDown);
        window.removeEventListener('keyup', handleKeyUp);
        cancelAnimationFrame(requestRef.current); 
    };
  }, [loop, handleAction]);

  const startLevel = (num, forcedChar = null) => {
    const config = LEVEL_CONFIGS[num];
    playerRef.current = { 
      worldX: 0, 
      x: window.innerWidth / 2,
      y: getGroundY(0) - (PLAYER_SIZE * (config?.charScale || 1)), 
      vy: 0, 
      frame: 0, 
      passedObstacles: new Set() 
    };
    entitiesRef.current = [];
    isCelebrating.current = false;
    
    let char = forcedChar || gameState.character;
    if (num === 4) char = 'female';
    else if (num === 2) char = 'male';

    setGameState(prev => ({ 
      ...prev, 
      status: GameStatus.PLAYING, 
      levelNumber: num, 
      character: char, 
      score: 0, 
      pizzasCaught: 0, 
      zsTapped: 0 
    }));
  };

  const drawAvatar = (ctx, x, y, char, frame, isNPC, scale, isFallingAsleep = false) => {
    ctx.save(); 
    ctx.translate(x, y); 
    const s = (PLAYER_SIZE / 100) * scale; 
    ctx.scale(s, s); 
    ctx.translate(-50, 0); 
    const bounce = (isNPC || isCelebrating.current) && !isFallingAsleep ? (Math.floor(frame / 10) % 2) * 12 : 0;
    ctx.translate(0, bounce);
    renderCharacterBase(ctx, char, frame, isFallingAsleep);
    ctx.restore();
  };

  const drawGround = (ctx, x, y, width, levelConfig, worldX, cameraOffset) => {
    const { primaryColor, shadowColor } = levelConfig;
    ctx.fillStyle = primaryColor;
    ctx.beginPath();
    ctx.moveTo(x, y + cameraOffset);
    const segmentWorldXEnd = worldX + width;
    const yEnd = getGroundY(segmentWorldXEnd);
    ctx.lineTo(x + width, yEnd + cameraOffset);
    ctx.lineTo(x + width, yEnd + cameraOffset + 5000);
    ctx.lineTo(x, y + cameraOffset + 5000);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle = shadowColor;
    for (let i = 0; i < width; i += 60) {
        let gx = x + i;
        let gy = getGroundY(worldX + i) + cameraOffset;
        ctx.fillRect(gx, gy - 6, 8, 4); 
    }
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(x, y + cameraOffset - 2);
    ctx.lineTo(x + width, getGroundY(worldX + width) + cameraOffset - 2);
    ctx.stroke();
  };

  const drawDuskCityscape = (ctx, width, height, worldX, frame) => {
    const skyGrad = ctx.createLinearGradient(0, 0, 0, height);
    skyGrad.addColorStop(0, '#020617');
    skyGrad.addColorStop(1, '#4c1d95');
    ctx.fillStyle = skyGrad;
    ctx.fillRect(0, 0, width, height);
    ctx.fillStyle = "#fff";
    for(let i=0; i<30; i++) {
        let starX = (i * 137) % width;
        let starY = (i * 223) % (height * 0.4);
        ctx.fillRect(starX, starY, 2, 2);
    }
  };

  const drawMountainMorning = (ctx, width, height, worldX, frame) => {
    const skyGrad = ctx.createLinearGradient(0, 0, 0, height);
    skyGrad.addColorStop(0, '#bae6fd');
    skyGrad.addColorStop(1, '#fef9c3');
    ctx.fillStyle = skyGrad;
    ctx.fillRect(0, 0, width, height);
  };

  const drawPillowMonster = (ctx, x, y, frame) => {
    ctx.save();
    ctx.translate(x, y);
    const hop = (Math.floor(frame / 8) % 2) * 15;
    ctx.translate(0, -hop - 35);
    drawPixelRect(ctx, -35, 0, 70, 50, '#ffffff', '#cbd5e1');
    ctx.restore();
  };

  const drawTree = (ctx, x, y) => {
    ctx.save();
    ctx.translate(x, y);
    drawPixelRect(ctx, -10, -30, 20, 30, '#78350f', '#451a03');
    ctx.fillStyle = '#065f46';
    ctx.beginPath();
    ctx.moveTo(0, -90);
    ctx.lineTo(-40, -30);
    ctx.lineTo(40, -30);
    ctx.fill();
    ctx.restore();
  };

  const drawFebreze = (ctx, x, y) => {
    ctx.save();
    ctx.translate(x, y - 90);
    const silver = '#94a3b8';
    const silverShadow = '#475569';
    const silverHighlight = '#e2e8f0';
    drawPixelRect(ctx, -20, 30, 40, 60, silver, silverShadow);
    ctx.fillStyle = silverHighlight;
    ctx.fillRect(-16, 30, 6, 60);
    const blue = '#2563eb';
    const darkBlue = '#1e3a8a';
    drawPixelRect(ctx, -20, 10, 40, 20, blue, darkBlue);
    ctx.fillStyle = '#000000';
    ctx.fillRect(-2, 4, 4, 6); 
    drawPixelRect(ctx, -6, 0, 12, 10, silver, silverShadow);
    ctx.restore();
  };

  const drawHeart = (ctx, x, y, frame, large = false) => {
    const baseScale = large ? 3.0 : 1.0;
    const pulse = Math.sin(frame * 0.1) * 0.4;
    const scale = baseScale + pulse;
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(scale, scale);
    ctx.fillStyle = '#ef4444';
    ctx.fillRect(-10, -5, 8, 5); 
    ctx.fillRect(2, -5, 8, 5);  
    ctx.fillRect(-12, 0, 24, 8); 
    ctx.fillRect(-10, 8, 20, 6); 
    ctx.fillRect(-6, 14, 12, 6); 
    ctx.fillRect(-2, 20, 4, 4);  
    ctx.restore();
  };

  const pizzaGoal = gameState.character === 'male' ? 20 : 4;

  return (
    <div className="w-screen h-screen bg-[#0c0a1f] flex items-center justify-center overflow-hidden text-white select-none relative" style={{ fontFamily: "'Press Start 2P', cursive" }}>
      <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
      <canvas ref={canvasRef} className="fixed inset-0 w-full h-full z-0" />

      {/* Game HUD */}
      {gameState.status === GameStatus.PLAYING && (
        <div className="fixed top-8 left-8 right-8 flex justify-between items-start z-40 pointer-events-none">
          <div className="bg-black/50 backdrop-blur-sm p-4 border-2 border-white/30 rounded-lg flex flex-col gap-2">
            <span className="text-[#f43f5e] text-lg uppercase tracking-widest" style={{ textShadow: '2px 2px 0px #000' }}>
              {LEVEL_CONFIGS[gameState.levelNumber].themeName}
            </span>
          </div>

          <div className="bg-black/50 backdrop-blur-sm p-4 border-2 border-white/30 rounded-lg flex flex-col items-end gap-2">
            {gameState.levelNumber === 3 ? (
                <span className="text-white text-lg">PIZZAS: {gameState.pizzasCaught} / {pizzaGoal}</span>
            ) : gameState.levelNumber === 4 ? (
                <span className="text-white text-lg">WAKE UP: {gameState.zsTapped} / 10</span>
            ) : (
                <span className="text-white text-lg">SCORE: {String(gameState.score).padStart(6, '0')}</span>
            )}
          </div>
        </div>
      )}

      {/* Main Menu */}
      {gameState.status === GameStatus.MENU && (
        <div className="flex flex-col items-center justify-center z-50 p-8">
          <h1 className="text-6xl font-black mb-12 text-[#f43f5e] italic" style={{ textShadow: '8px 8px 0px #000' }}>JAROMY</h1>
          <div className="flex flex-col gap-4">
            <button onClick={() => setGameState(prev => ({ ...prev, status: GameStatus.SELECT_CHAR }))} className="bg-[#f43f5e] px-12 py-6 border-4 border-white shadow-[0_12px_0_0_#991b1b]">START MISSION</button>
            <button onClick={() => setGameState(prev => ({ ...prev, status: GameStatus.LEVEL_SELECT }))} className="bg-slate-700 px-12 py-4 border-4 border-white">SELECT MISSION</button>
          </div>
        </div>
      )}

      {/* Story Screens */}
      {gameState.status === GameStatus.STORY_INTRO && (
        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-black/95">
          <div className="bg-slate-900 border-4 border-white p-10 max-w-xl text-center">
            <p className="text-sm mb-12 uppercase leading-loose">"Find your partner at the end of the river path. Jump over the 6 Pillow Monsters!"</p>
            <button onClick={() => startLevel(1)} className="bg-white text-black px-12 py-6">INITIALIZE</button>
          </div>
        </div>
      )}

      {gameState.status === GameStatus.STORY_INTERSTITIAL && (
        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-black p-8 text-center">
          <div className="max-w-2xl">
            <p className="text-lg mb-12 leading-loose">"They didn't talk to each other after that..."</p>
            <p className="text-lg mb-16 leading-loose">"Then Romy messaged James..."</p>
            <button onClick={() => setGameState(prev => ({ ...prev, status: GameStatus.PIZZA_DECISION_PRE }))} className="bg-white text-black px-12 py-6 border-4 border-white">NEXT</button>
          </div>
        </div>
      )}

      {gameState.status === GameStatus.PIZZA_DECISION_PRE && (
        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-[#fbbf24]">
          <h2 className="text-6xl text-black mb-20 font-black" style={{ textShadow: '4px 4px 0px rgba(0,0,0,0.1)' }}>PIZZA?</h2>
          <div className="flex gap-8">
            <button onClick={() => setGameState(prev => ({ ...prev, status: GameStatus.MOUNTAIN_INSTRUCTIONS }))} className="bg-black text-white px-12 py-6 border-4 border-white">YES</button>
            <button onClick={() => setGameState(prev => ({ ...prev, status: GameStatus.MENU }))} className="bg-black text-white px-12 py-6 border-4 border-white">NO</button>
          </div>
        </div>
      )}

      {gameState.status === GameStatus.MOUNTAIN_INSTRUCTIONS && (
        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-slate-900 p-12 text-center">
          <div className="max-w-xl">
            <p className="text-sm mb-16 leading-loose uppercase">
              "Pizza sounds good, but James is at the top of a mountain. Hurry down, but don't hit any trees!"
            </p>
            <button onClick={() => startLevel(2)} className="bg-[#f43f5e] text-white px-12 py-6 border-4 border-white">START</button>
          </div>
        </div>
      )}

      {gameState.status === GameStatus.POST_MOUNTAIN_STORY && (
        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-slate-900 p-12 text-center">
          <div className="max-w-xl">
            <p className="text-sm mb-16 leading-loose uppercase">
              "James made it down the mountain! Good thing he got Febreze, because he stinks!"
            </p>
            <button onClick={() => setGameState(prev => ({ ...prev, status: GameStatus.LEVEL_3_PRE_SELECT }))} className="bg-white text-black px-12 py-6 border-4 border-white">NEXT</button>
          </div>
        </div>
      )}

      {gameState.status === GameStatus.LEVEL_3_PRE_SELECT && (
        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-[#fbbf24] p-12 text-center">
          <div className="max-w-xl">
            <p className="text-lg text-black mb-16 font-black uppercase">
              "Time to eat pizza, pick your character"
            </p>
            <button onClick={() => setGameState(prev => ({ ...prev, status: GameStatus.LEVEL_3_CHAR_SELECT }))} className="bg-black text-white px-12 py-6 border-4 border-white">NEXT</button>
          </div>
        </div>
      )}

      {/* Level Select */}
      {gameState.status === GameStatus.LEVEL_SELECT && (
        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-[#0c0a1f] p-8">
          <h2 className="text-2xl mb-12 text-[#f43f5e]">SELECT MISSION</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
            {[1, 2, 3, 4].map(num => (
              <button key={num} onClick={() => {
                if (num === 1) setGameState(prev => ({ ...prev, status: GameStatus.STORY_INTRO }));
                else if (num === 3) setGameState(prev => ({ ...prev, status: GameStatus.LEVEL_3_CHAR_SELECT }));
                else startLevel(num);
              }} className="p-6 bg-slate-800 border-4 border-white hover:bg-[#f43f5e] transition-colors flex flex-col items-center gap-2">
                <span className="text-xs opacity-50">LEVEL {num}</span>
                <span className="text-sm">{LEVEL_CONFIGS[num].themeName}</span>
              </button>
            ))}
          </div>
          <button onClick={() => setGameState(prev => ({ ...prev, status: GameStatus.MENU }))} className="mt-12 text-xs underline">BACK</button>
        </div>
      )}

      {/* Level 3 Specific Character Select */}
      {gameState.status === GameStatus.LEVEL_3_CHAR_SELECT && (
        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-[#fbbf24]">
          <h2 className="text-2xl mb-16 uppercase text-black font-black">WHO WANTS TO EAT PIZZA?</h2>
          <div className="flex gap-12">
            <button onClick={() => startLevel(3, 'male')} className="flex flex-col items-center">
              <div className="w-48 h-64 bg-[#2563eb] border-4 border-black shadow-[8px_8px_0_0_#000] flex items-center justify-center"><AvatarIcon char="male" renderFn={renderCharacterBase} /></div>
              <span className="mt-6 text-black">JAMES (EATS 20)</span>
            </button>
            <button onClick={() => startLevel(3, 'female')} className="flex flex-col items-center">
              <div className="w-48 h-64 bg-[#f43f5e] border-4 border-black shadow-[8px_8px_0_0_#000] flex items-center justify-center"><AvatarIcon char="female" renderFn={renderCharacterBase} /></div>
              <span className="mt-6 text-black">ROMY (EATS 4)</span>
            </button>
          </div>
        </div>
      )}

      {/* Post-Pizza Narrative */}
      {gameState.status === GameStatus.DATING_BEGINS && (
        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-[#f43f5e]">
          <h2 className="text-3xl text-center mb-16 font-black leading-loose">LET THE DATING BEGIN!</h2>
          <button onClick={() => setGameState(prev => ({ ...prev, status: GameStatus.GO_TO_SAIPAN }))} className="bg-white text-black px-12 py-6 border-4 border-black">NEXT</button>
        </div>
      )}

      {gameState.status === GameStatus.GO_TO_SAIPAN && (
        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-[#bae6fd]">
          <h2 className="text-3xl text-center text-black mb-16 font-black leading-loose">LET'S GO TO SAIPAN!</h2>
          <button onClick={() => setGameState(prev => ({ ...prev, status: GameStatus.LEVEL_4_INTRO }))} className="bg-black text-white px-12 py-6 border-4 border-white">NEXT</button>
        </div>
      )}

      {gameState.status === GameStatus.LEVEL_4_INTRO && (
        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-[#0f172a] p-8 text-center">
          <h2 className="text-xl mb-12 uppercase leading-loose">Romy is falling asleep at the airport, tap the Zs to keep her awake!</h2>
          <button onClick={() => startLevel(4)} className="bg-[#f43f5e] text-white px-12 py-6 border-4 border-white">START</button>
        </div>
      )}

      {/* Character Select */}
      {gameState.status === GameStatus.SELECT_CHAR && (
        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-[#0c0a1f]">
          <h2 className="text-xl mb-16 uppercase">SELECT AGENT</h2>
          <div className="flex gap-12">
            <button onClick={() => setGameState(prev => ({ ...prev, character: 'male', status: GameStatus.STORY_INTRO }))} className="flex flex-col items-center">
              <div className="w-48 h-64 bg-[#2563eb] border-4 border-white shadow-[8px_8px_0_0_#1e3a8a] flex items-center justify-center"><AvatarIcon char="male" renderFn={renderCharacterBase} /></div>
              <span className="mt-6">JAMES</span>
            </button>
            <button onClick={() => setGameState(prev => ({ ...prev, character: 'female', status: GameStatus.STORY_INTRO }))} className="flex flex-col items-center">
              <div className="w-48 h-64 bg-[#f43f5e] border-4 border-white shadow-[8px_8px_0_0_#9f1239] flex items-center justify-center"><AvatarIcon char="female" renderFn={renderCharacterBase} /></div>
              <span className="mt-6">ROMY</span>
            </button>
          </div>
        </div>
      )}

      {/* Game Over */}
      {gameState.status === GameStatus.GAMEOVER && (
        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-black/90">
          <h2 className="text-2xl mb-12 text-red-500 uppercase">MISSION FAILED</h2>
          <button onClick={() => startLevel(gameState.levelNumber)} className="bg-[#f43f5e] px-12 py-6 border-4 border-white mb-6">RETRY</button>
          <button onClick={() => setGameState(prev => ({ ...prev, status: GameStatus.MENU }))} className="text-xs underline">QUIT</button>
        </div>
      )}

      {/* Level Complete Final */}
      {gameState.status === GameStatus.LEVEL_COMPLETE && (
        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-green-900 text-center px-6">
           <h2 className="text-2xl mb-8 uppercase">MISSION COMPLETE!</h2>
           <p className="text-xs mb-12 uppercase leading-relaxed max-w-md">Romy is finally awake. The vacation can begin!</p>
           <button onClick={() => setGameState(prev => ({ ...prev, status: GameStatus.MENU }))} className="bg-white text-black px-12 py-4 text-xs">RETURN TO BASE</button>
        </div>
      )}
    </div>
  );
};

const AvatarIcon = ({ char, renderFn }) => {
  const ref = useRef(null);
  useEffect(() => {
    if (!ref.current) return;
    const ctx = ref.current.getContext('2d');
    ctx.clearRect(0,0,100,100);
    renderFn(ctx, char);
  }, [char, renderFn]);
  return <canvas ref={ref} width="100" height="100" className="scale-150" />;
};
const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>